{"version":3,"sources":["../../../src/utils/json/parse-partial-json.ts"],"sourcesContent":["import sjson from \"secure-json-parse\";\nimport { fixJson } from \"./fix-json\";\nimport {\n  ContentPartStatus,\n  ToolCallContentPartStatus,\n} from \"../../types/AssistantTypes\";\nimport { useContentPart } from \"../../context\";\n\nconst PARTIAL_JSON_COUNT_SYMBOL = Symbol(\"partial-json-count\");\nexport const parsePartialJson = (json: string) => {\n  try {\n    return sjson.parse(json);\n  } catch {\n    try {\n      const [fixedJson, partialCount] = fixJson(json);\n      const res = sjson.parse(fixedJson);\n      res[PARTIAL_JSON_COUNT_SYMBOL] = partialCount;\n      return res;\n    } catch {\n      return undefined;\n    }\n  }\n};\n\nconst COMPLETE_STATUS = Object.freeze({ type: \"complete\" });\n\nconst getFieldStatus = (\n  lastState: ContentPartStatus,\n  args: unknown,\n  fieldPath: string[],\n  partialCount: number,\n): ContentPartStatus => {\n  if (fieldPath.length === 0) return lastState;\n  if (typeof args !== \"object\" || args === null) return COMPLETE_STATUS;\n\n  const path = fieldPath.at(-1)!;\n\n  // If the expected property does not exist, mark as incomplete\n  if (!Object.prototype.hasOwnProperty.call(args, path)) {\n    return lastState;\n  }\n\n  const argsKeys = Object.keys(args);\n  const isLast = argsKeys[argsKeys.length - 1] === path;\n  if (!isLast) return COMPLETE_STATUS;\n\n  return getFieldStatus(\n    lastState,\n    (args as Record<string, unknown>)[path],\n    fieldPath.slice(0, -1),\n    partialCount - 1,\n  );\n};\n\nconst getToolArgsFieldStatus = (\n  status: ToolCallContentPartStatus,\n  args: Record<string, unknown>,\n  fieldPath: string[],\n): ContentPartStatus => {\n  const partialCount = (args as any)[PARTIAL_JSON_COUNT_SYMBOL] ?? 0;\n  if (partialCount === 0) return COMPLETE_STATUS;\n\n  const lastState: ContentPartStatus =\n    status.type !== \"requires-action\" ? status : COMPLETE_STATUS;\n\n  return getFieldStatus(lastState, args, fieldPath, partialCount);\n};\n\nexport const useToolArgsFieldStatus = (fieldPath: string[]) => {\n  return useContentPart((p) => {\n    if (p.type !== \"tool-call\") throw new Error(\"not a tool call\");\n    return getToolArgsFieldStatus(p.status, p.args, fieldPath);\n  });\n};\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAAkB;AAClB,sBAAwB;AAKxB,qBAA+B;AAE/B,IAAM,4BAA4B,OAAO,oBAAoB;AACtD,IAAM,mBAAmB,CAAC,SAAiB;AAChD,MAAI;AACF,WAAO,yBAAAA,QAAM,MAAM,IAAI;AAAA,EACzB,QAAQ;AACN,QAAI;AACF,YAAM,CAAC,WAAW,YAAY,QAAI,yBAAQ,IAAI;AAC9C,YAAM,MAAM,yBAAAA,QAAM,MAAM,SAAS;AACjC,UAAI,yBAAyB,IAAI;AACjC,aAAO;AAAA,IACT,QAAQ;AACN,aAAO;AAAA,IACT;AAAA,EACF;AACF;AAEA,IAAM,kBAAkB,OAAO,OAAO,EAAE,MAAM,WAAW,CAAC;AAE1D,IAAM,iBAAiB,CACrB,WACA,MACA,WACA,iBACsB;AACtB,MAAI,UAAU,WAAW,EAAG,QAAO;AACnC,MAAI,OAAO,SAAS,YAAY,SAAS,KAAM,QAAO;AAEtD,QAAM,OAAO,UAAU,GAAG,EAAE;AAG5B,MAAI,CAAC,OAAO,UAAU,eAAe,KAAK,MAAM,IAAI,GAAG;AACrD,WAAO;AAAA,EACT;AAEA,QAAM,WAAW,OAAO,KAAK,IAAI;AACjC,QAAM,SAAS,SAAS,SAAS,SAAS,CAAC,MAAM;AACjD,MAAI,CAAC,OAAQ,QAAO;AAEpB,SAAO;AAAA,IACL;AAAA,IACC,KAAiC,IAAI;AAAA,IACtC,UAAU,MAAM,GAAG,EAAE;AAAA,IACrB,eAAe;AAAA,EACjB;AACF;AAEA,IAAM,yBAAyB,CAC7B,QACA,MACA,cACsB;AACtB,QAAM,eAAgB,KAAa,yBAAyB,KAAK;AACjE,MAAI,iBAAiB,EAAG,QAAO;AAE/B,QAAM,YACJ,OAAO,SAAS,oBAAoB,SAAS;AAE/C,SAAO,eAAe,WAAW,MAAM,WAAW,YAAY;AAChE;AAEO,IAAM,yBAAyB,CAAC,cAAwB;AAC7D,aAAO,+BAAe,CAAC,MAAM;AAC3B,QAAI,EAAE,SAAS,YAAa,OAAM,IAAI,MAAM,iBAAiB;AAC7D,WAAO,uBAAuB,EAAE,QAAQ,EAAE,MAAM,SAAS;AAAA,EAC3D,CAAC;AACH;","names":["sjson"]}